<spec_before_code_enforcement>
  <!--
    CRITICAL ENFORCEMENT: Code mode MUST verify specification exists before implementation.
    
    This enforcement applies regardless of how Code mode is invoked:
    - Direct user invocation
    - Orchestrator delegation
    - Cross-mode delegation
    - Manual mode switching
    
    All details in referenced shared pattern.
  -->

  <overview>
    The project online Code mode enforces specification-first development.
    
    BEFORE ANY IMPLEMENTATION WORK:
    - Specification document must exist
    - Specification must be approved by user
    - Specification file path must be provided
    
    See ../../sdlc/shared/spec-before-code-enforcement.md for complete workflow.
  </overview>

  <shared_pattern>sdlc/shared/spec-before-code-enforcement.md</shared_pattern>

  <mandatory_startup_check>
    <step number="1">
      <action>Detect if this is new feature/enhancement implementation</action>
      <indicators>
        - User mentions "implement", "create", "build", "add feature"
        - Jira ticket indicates new feature or enhancement
        - Request involves creating new functionality
      </indicators>
    </step>

    <step number="2">
      <action>Check for specification file</action>
      <questions>
        - "What is the specification file path for this implementation?"
        - "Has the specification been created and approved?"
      </questions>
    </step>

    <step number="3">
      <action>Verify specification exists</action>
      <validation>
        - Use read_file to verify specification file exists
        - Confirm specification is complete and approved
      </validation>
    </step>

    <step number="4">
      <action>If no specification exists - REFUSE and DELEGATE</action>
      <response>
        I cannot proceed with implementation without an approved specification.
        
        According to the project online SDLC workflow, specifications must be
        created and approved BEFORE any code implementation begins.
        
        Let me route this to project online Spec mode to create the specification first.
      </response>
      <delegation>
        Use switch_mode tool to delegate to "spec" mode for specification creation.
      </delegation>
    </step>
  </mandatory_startup_check>

  <violation_prevention>
    <rule priority="critical">
      NEVER start implementation without verified specification file path
    </rule>
    
    <rule priority="critical">
      NEVER rationalize or bypass specification requirement
    </rule>
    
    <rule priority="critical">
      NEVER assume specification exists without explicit verification
    </rule>
    
    <rule priority="critical">
      ALWAYS delegate to Spec mode if specification is missing
    </rule>
  </violation_prevention>

  <exception_handling>
    <exception type="user_explicit_bypass">
      <condition>User explicitly says "skip spec" or "use existing spec at [path]"</condition>
      <action>Confirm with user before proceeding</action>
      <confirmation>
        You've requested to bypass specification creation. This is not recommended
        as it may lead to unclear requirements and rework.
        
        Are you sure you want to proceed without a specification? (Yes/No)
      </confirmation>
    </exception>

    <exception type="incremental_update">
      <condition>Modifying existing code with clear, small scope</condition>
      <action>Specification may be optional for minor updates</action>
      <validation>
        Verify this is truly incremental (bug fix, small refactor, minor update)
        and not a new feature or significant enhancement.
      </validation>
    </exception>
  </exception_handling>

  <user_communication_templates>
    <template name="missing_spec_refusal">
      I cannot proceed with implementing {feature_name} without an approved specification.
      
      The project online SDLC requires specification-first development to ensure:
      - Clear requirements documentation
      - User review and approval of approach
      - Proper architectural planning
      - Reduced rework from misunderstood requirements
      
      Let me route this to project online Spec mode to create the specification first.
      Once you've reviewed and approved the spec, I'll proceed with implementation.
    </template>

    <template name="spec_verification">
      Before I begin implementation, I need to verify the specification:
      
      - What is the specification file path? (e.g., sdlc/docs/specs/feature-name.md)
      - Has this specification been reviewed and approved?
      
      Once confirmed, I'll proceed with implementation following the approved spec.
    </template>

    <template name="delegation_to_spec">
      Routing to project online Spec mode to create specification for {feature_name}.
      
      Once the specification is created and you've approved it, I'll return to
      implement the feature according to the approved specification.
    </template>
  </user_communication_templates>

  <integration_with_orchestrator>
    <principle>
      Both Orchestrator and Code mode enforce spec-before-code independently.
      This provides defense-in-depth against workflow violations.
    </principle>

    <orchestrator_path>
      User → Orchestrator → Routes to Spec → User approves → Routes to Code
    </orchestrator_path>

    <direct_code_path>
      User → Code (direct) → Checks for spec → No spec → Refuses → Delegates to Spec
    </direct_code_path>

    <result>
      Specification-first is enforced regardless of entry point.
    </result>
  </integration_with_orchestrator>

  <mode_behavior>
    Execute mandatory startup check from this file.
    Reference shared pattern for complete workflow details.
    NEVER bypass specification requirement without explicit user confirmation.
  </mode_behavior>
</spec_before_code_enforcement>