% Smartsheet brand colors
\definecolor{smartsheetdarkblue}{RGB}{0,15,51}
\definecolor{smartsheetblue}{RGB}{0,99,190}
\definecolor{smartsheetlightgray}{RGB}{242,242,242}

% Enhanced packages
\usepackage{fancyhdr}
\usepackage{titlesec}
\usepackage{tocloft}
\usepackage{fontspec}

% Font configuration - TT Norms with Helvetica/Arial fallback
% XeLaTeX will automatically fall back if font not found
\setmainfont{Helvetica}[
  Scale=1.0
]
\setsansfont{Helvetica}[
  Scale=1.0
]

% Code block wrapping and formatting
\usepackage{listings}
\usepackage{fancyvrb}

% Configure listings for code blocks with wrapping
% Using footnotesize (~7pt) for narrower code block text
\lstset{
  basicstyle=\ttfamily\footnotesize,
  breaklines=true,
  breakatwhitespace=true,
  postbreak=\mbox{\textcolor{smartsheetblue}{$\hookrightarrow$}\space},
  columns=flexible,
  keepspaces=true,
  showstringspaces=false,
  frame=single,
  framerule=0.5pt,
  rulecolor=\color{smartsheetlightgray},
  backgroundcolor=\color{smartsheetlightgray},
  xleftmargin=5pt,
  xrightmargin=5pt
}

% Prevent code overflow
\usepackage{etoolbox}
\makeatletter
\preto{\@verbatim}{\topsep=0pt \partopsep=0pt}
\makeatother

% Better table handling for wide tables
\usepackage{tabularx}
\usepackage{ltablex}  % Combines longtable + tabularx for multi-page tables

% Make tables break across pages and handle cell content better
\setlength{\LTcapwidth}{\textwidth}
\keepXColumns

% Allow table cells to wrap text better
\newcolumntype{L}{>{\raggedright\arraybackslash}X}
\newcolumntype{C}{>{\centering\arraybackslash}X}
\newcolumntype{R}{>{\raggedleft\arraybackslash}X}

% Reduce default column padding slightly for better fit
\setlength{\tabcolsep}{4pt}

% Make tables use smaller font (7pt - 2 points smaller than body)
\AtBeginEnvironment{longtable}{\footnotesize}
\AtBeginEnvironment{tabular}{\footnotesize}
\AtBeginEnvironment{tabularx}{\footnotesize}

% Adjust pandoc's default column width calculations
% This affects how pandoc distributes column widths in tables
\makeatletter
\def\LT@col@width#1{%
  \ifcase#1
    0.12\textwidth\or  % Column 1 (Column Name) - narrower
    0.18\textwidth\or  % Column 2 (What It Stores) - narrower
    0.45\textwidth\or  % Column 3 (Source) - wider
    0.20\textwidth     % Column 4 (Example)
  \fi
}
\makeatother

% Custom title page command
\usepackage{afterpage}
\newcommand{\customtitlepage}{
    \begin{titlepage}
        \centering
        
        % Top spacing
        \vspace*{1cm}
        
        % Smartsheet logo text at top
        {\fontsize{32}{38}\selectfont\textcolor{smartsheetblue}{\textbf{Smartsheet}}\par}
        
        \vspace{3cm}
        
        % Title box with light gray background
        \begin{center}
        \colorbox{smartsheetlightgray}{
            \begin{minipage}{0.85\textwidth}
                \centering
                \vspace{1.5cm}
                {\fontsize{36}{43}\selectfont\textcolor{smartsheetdarkblue}{\textbf{Migrating to Smartsheet}}\par}
                \vspace{0.5cm}
                {\fontsize{24}{29}\selectfont\textcolor{smartsheetdarkblue}{\textbf{from Project Online}}\par}
                \vspace{1.5cm}
            \end{minipage}
        }
        \end{center}
        
        \vspace{2.5cm}
        
        % Subtitle
        {\fontsize{16}{19}\selectfont Complete Migration Guide\par}
        
        \vspace{0.5cm}
        
        % Date
        {\fontsize{14}{17}\selectfont December 2024\par}
        
        \vfill
        
        % Footer
        {\fontsize{14}{17}\selectfont\textcolor{smartsheetblue}{\textbf{Smartsheet}}\par}
        \vspace{0.5cm}
    \end{titlepage}
    % Clear page after title page
    \clearpage
}

% Chapter formatting
\titleformat{\chapter}[display]
{\normalfont\huge\bfseries\color{smartsheetdarkblue}}
{\chaptertitlename\ \thechapter}{20pt}{\Huge}

\titleformat{\section}
{\normalfont\Large\bfseries\color{smartsheetdarkblue}}
{\thesection}{1em}{}

\titleformat{\subsection}
{\normalfont\large\bfseries\color{smartsheetdarkblue}}
{\thesubsection}{1em}{}

% Table of contents formatting
\renewcommand{\contentsname}{\textcolor{smartsheetdarkblue}{Table of Contents}}
\renewcommand{\cftchapfont}{\bfseries\color{smartsheetdarkblue}}
\renewcommand{\cftsecfont}{\color{smartsheetdarkblue}}

% Page headers and footers
\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{\textcolor{smartsheetdarkblue}{\small Migrating to Smartsheet from Project Online}}
\fancyfoot[L]{\textcolor{smartsheetblue}{\small\textbf{Smartsheet}}}
\fancyfoot[R]{\textcolor{smartsheetdarkblue}{\thepage}}

% Plain style for chapter pages
\fancypagestyle{plain}{
    \fancyhf{}
    \fancyfoot[L]{\textcolor{smartsheetblue}{\small\textbf{Smartsheet}}}
    \fancyfoot[R]{\textcolor{smartsheetdarkblue}{\thepage}}
    \renewcommand{\headrulewidth}{0pt}
}

% Header rule
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\headrule}{\hbox to\headwidth{\color{smartsheetblue}\leaders\hrule height \headrulewidth\hfill}}

% Apply custom title page after document begins
\AtBeginDocument{\customtitlepage}